{% extends "layout.html" %}
{% block breadcrumbs %}{{ block.super }} : <a href="{% url 'index' %}">Stratum0</a> : <a href="{% url 'details' stratum0.fqrn %}">{{ stratum0.fqrn }}</a>{% endblock %}

{% load staticfiles %}

{% block content %}

<div class="container" style="margin-top: 20px; margin-bottom: 30px">
<img src="{% static "images/stratum0.png" %}" class="pull-left" style="margin-right: 20px">
<h1 style="margin: auto">{{ stratum0 }}</h1>
</div>

<h2>Local Stratum 0</h2>
<table class="table">
    <tr>
        <td>Stratum0 Revision:</td>
        <td>{{ stratum0.manifest.revision }}</td>
    </tr>
    <tr>
        <td>CernVM-FS Version:</td>
        <td>{{ stratum0.version }}</td>
    </tr>
    <tr>
        <td>Last Modified:</td>
        <td>{{ stratum0.manifest.last_modified }}</td>
    </tr>
    <tr>
        <td>Root Catalog Hash:</td>
        <td>{{ stratum0.manifest.root_catalog }}</td>
    </tr>
    <tr>
        <td>Number of known Stratum 1 Replicas:</td>
        <td>{{ stratum1_list|length }}</td>
    </tr>
</table>

<h2>Stratum 1 Replicas</h2>

<script type="text/javascript">
var stratum1s = [
{% for stratum1 in stratum1_list %}
{
    "id"            : "{{ stratum1.id   }}",
    "name"          : "{{ stratum1.name }}",
    "info_url"      : "{% url 'stratum1_details' stratum0.fqrn stratum1.id %}"
},
{% endfor %}
];
var stratum0_revision = {{ stratum0.manifest.revision }};

function replace_image(img_object, nem_img_filename) {
    var base = img_object.attr("src").match(/([^\.]+\/)[^\/]+/)[1];
    img_object.attr("src", base + nem_img_filename)
    new RetinaImage(img_object[0])
}

window.onload = function() {
    for (var i = 0; i < stratum1s.length; ++i) {
        $.getJSON(stratum1s[i].info_url).done(function(data) {
            if (data.status != "ok") return;
            var s1_dom_id = '#stratum1_' + data.name;

            // insert status icon
            var s1_status_img = $(s1_dom_id + " .stratum1_state");
            if (data.replicating == "True") {
                replace_image(s1_status_img, "spinner.gif");
            } else if (data.revision != stratum0_revision) {
                replace_image(s1_status_img, "cross.png");
            } else {
                replace_image(s1_status_img, "tick.png");
            }

            // insert CernVM-FS version
            var v_str = "(does not provide RESTful API)";
            if (data.rest_api == "True") {
                var v_str = "(running CernVM-FS " + data.version + ")";
            }
            $(s1_dom_id + " .stratum1_version").html(v_str);

            // insert Stratum1 revision numbers
            $(s1_dom_id + " .stratum1_revision").html(data.revision);

            // insert last replication timestamp
            $(s1_dom_id + " .stratum1_last_repl").html(data.last_replication);

            // show replication button
            if (data.rest_api != "True" || data.revision == stratum0_revision) {
                $(s1_dom_id + " .stratum1_repl_button").hide();
            }
        });
    }
}
</script>

{% for stratum1 in stratum1_list %}
<div class="container" style="margin-bottom: 20px" id="stratum1_{{ stratum1.name }}">
    <div class="pull-left" style="margin-right: 20px">
        <img src="{% static "images/spinner.gif" %}" class="stratum1_state">
    </div>
    <div class="container pull-left" style="width: 500px">
        <div>
            <h4>{{ stratum1.name }} Replica <small class="stratum1_version"></small></h4>
        </div>
        <div>
            Current Revision: <span class="stratum1_revision"></span>
            <small>(Last Replication: <span class="stratum1_last_repl"></span>)</small>
        </div>
    </div>
    <div class="pull-left stratum1_repl_button" style="margin-top: 16px">
         <a href="{% url 'replicate' stratum0.fqrn stratum1.id %}" class="stratum1_repl_link"><img src="{% static "images/replicate.png" %}"></a>
    </div>
</div>
{% endfor %}

{% endblock %}
