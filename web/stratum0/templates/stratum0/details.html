{% extends "layout.html" %}
{% block breadcrumbs %}{{ block.super }} : <a href="{% url 'index' %}">Stratum0</a> : <a href="{% url 'details' stratum0.fqrn %}">{{ stratum0.fqrn }}</a>{% endblock %}

{% load staticfiles %}

{% block content %}

<div class="container" style="margin-top: 20px; margin-bottom: 30px">
<img src="{% static "images/stratum0.png" %}" class="pull-left" style="margin-right: 20px">
<h1 style="margin: auto">{{ stratum0 }}</h1>
</div>

<h2>Local Stratum 0</h2>
<table class="table">
    <tr>
        <td>Stratum0 Revision:</td>
        <td>{{ stratum0.manifest.revision }}</td>
    </tr>
    <tr>
        <td>CernVM-FS Version:</td>
        <td>{{ stratum0.version }}</td>
    </tr>
    <tr>
        <td>Last Modified:</td>
        <td>{{ stratum0.manifest.last_modified.isoformat }}</td>
    </tr>
    <tr>
        <td>Root Catalog Hash:</td>
        <td>{{ stratum0.manifest.root_catalog }}</td>
    </tr>
    <tr>
        <td>Number of known Stratum 1 Replicas:</td>
        <td>{{ stratum1_list|length }}</td>
    </tr>
</table>

<h2>Stratum 1 Replicas</h2>

<script type="text/javascript">
var stratum1s = [
{% for stratum1 in stratum1_list %}
{
    "id"            : "{{ stratum1.id   }}",
    "name"          : "{{ stratum1.name }}",
    "info_url"      : "{% url 'stratum1_details' stratum0.fqrn stratum1.id %}"
},
{% endfor %}
];
var stratum0_revision = {{ stratum0.manifest.revision }};

function compare_json(j1, j2) {
    var k1 = Object.keys(j1).sort();
    var k2 = Object.keys(j2).sort();
    if (k1.length != k2.length) return false;
    for (var i = 0; i < k1.length; ++i) {
        if (k1[i] != k2[i]) return false;
        if (typeof j1[k1[i]] != typeof j2[k2[i]]) return false;
        if (j1[k1[i]] != j2[k2[i]]) return false;
    }
    return true;
}

function update_retina_image(img_object) {
    var is_retina = img_object.attr("src").match(/^(.*)@2x(\..*)$/);
    if (is_retina) {
        img_object.attr("src", is_retina[1] + is_retina[2]);
    }
    img_object.attr("width", "");
    img_object.attr("height", "");
    new RetinaImage(img_object[0])
}

function replace_image(img_object, nem_img_filename) {
    var base = img_object.attr("src").match(/([^\.]+\/)[^\/]+/)[1];
    img_object.attr("src", base + nem_img_filename)
    update_retina_image(img_object);
}

function update_stratum1_display(s1_dom_id, json_data) {
    var s1_status_img         = $(s1_dom_id + " .stratum1_state");
    var s1_details_div        = $(s1_dom_id + " .stratum1_details");
    var s1_replication_button = $(s1_dom_id + " .stratum1_repl_button");

    if (json_data.status != "ok") {
        // show a red flag if something went wrong
        var s1_status_img = $(s1_dom_id + " .stratum1_state");
        replace_image(s1_status_img, "fail.png");
        s1_details_div.hide();
        return;
    } else {
        // uncover details div
        $(s1_dom_id + " .stratum1_details").show();
    }

    // insert status icon
    if (json_data.replicating == "True") {
        replace_image(s1_status_img, "spinner.gif");
    } else if (json_data.revision != stratum0_revision) {
        replace_image(s1_status_img, "cross.png");
    } else {
        replace_image(s1_status_img, "tick.png");
    }

    // insert CernVM-FS version
    var v_str = "(does not provide RESTful API)";
    if (json_data.rest_api == "True") {
        var v_str = "(running CernVM-FS " + json_data.version + ")";
    }
    $(s1_dom_id + " .stratum1_version").html(v_str);

    // insert Stratum1 revision numbers
    $(s1_dom_id + " .stratum1_revision").html(json_data.revision);

    // insert last replication timestamp
    $(s1_dom_id + " .stratum1_last_repl").html(new Date(json_data.last_replication));

    // show replication button
    if (json_data.rest_api == "True" && json_data.revision != stratum0_revision) {
        s1_replication_button.show();
    } else {
        s1_replication_button.hide();
    }
    update_retina_image($(s1_dom_id + " .stratum1_repl_button img"));
}

function update_stratum1_status(stratum1) {
    var s1_dom_id = '#stratum1_' + stratum1.id;

    var old_info          = (arguments.length > 1) ? arguments[1] : null;
    var nothing_new_since = (arguments.length > 2) ? arguments[2] : 1;

    $.getJSON(stratum1.info_url)
        .done(function(data) {
            // check if something has changed
            if (!old_info || !compare_json(old_info, data)) {
                nothing_new_since = 1;
                update_stratum1_display(s1_dom_id, data);
            } else {
                ++nothing_new_since;
            }

            // leaky bucket update check (maximal interval is 5 minutes)
            var next_update = Math.min(1000 * Math.pow(2, nothing_new_since),
                                       1000 * 60 * 5);
            setTimeout(function() {
                           update_stratum1_status(stratum1, data, nothing_new_since);
                       }, next_update);
        })
        .fail(function(data) {
            // show a red flag if something went wrong
            replace_image(s1_status_img, "fail.png");
        });
}

window.onload = function() {
    for (var i = 0; i < stratum1s.length; ++i) {
        update_stratum1_status(stratum1s[i]);
    }
}
</script>

{% for stratum1 in stratum1_list %}
<div class="container" style="margin-bottom: 20px" id="stratum1_{{ stratum1.id }}">
    <div class="pull-left" style="margin-right: 20px; width: 64px; height: 64px">
        <img src="{% static "images/loading.gif" %}" class="stratum1_state">
    </div>
    <div class="container pull-left" style="width: 500px">
        <div>
            <h4>{{ stratum1.name }} Replica <small class="stratum1_version"></small></h4>
        </div>
        <div class="stratum1_details" style="display: none;">
            Current Revision: <span class="stratum1_revision"></span>
            <small>(Last Replication: <span class="stratum1_last_repl"></span>)</small>
        </div>
    </div>
    <div class="pull-left stratum1_repl_button" style="margin-top: 16px; display: none;">
         <a href="{% url 'replicate' stratum0.fqrn stratum1.id %}" class="stratum1_repl_link">
             <img src="{% static "images/replicate.png" %}" width="32px" height="32px">
         </a>
    </div>
</div>
{% endfor %}

{% endblock %}
