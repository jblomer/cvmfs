{% extends "layout.html" %}
{% block breadcrumbs %}{{ block.super }} : <a href="{% url 'index' %}">Stratum0</a> : <a href="{% url 'details' stratum0.fqrn %}">{{ stratum0.fqrn }}</a>{% endblock %}

{% load staticfiles %}

{% block content %}

<div class="container" style="margin-top: 20px; margin-bottom: 30px">
<img src="{% static "images/stratum0.png" %}" class="pull-left" style="margin-right: 20px">
<h1 style="margin: auto">{{ stratum0 }}</h1>
</div>

<script type="text/javascript">
var stratum1s = [
{% for stratum1 in stratum1_list %}
{
    "id"            : "{{ stratum1.id   }}",
    "name"          : "{{ stratum1.name }}",
    "info_url"      : "{% url 'stratum1_details' stratum0.fqrn stratum1.id %}"
},
{% endfor %}
];

var initial_stratum0_revision = "{{ stratum0.manifest.revision }}";
var stratum0_fqrn             = "{{ stratum0.fqrn }}";
var stratum0_info_url         = "{% url 'stratum0_details' stratum0.fqrn %}";

function compare_json(j1, j2) {
    var k1 = Object.keys(j1).sort();
    var k2 = Object.keys(j2).sort();
    if (k1.length != k2.length) return false;
    for (var i = 0; i < k1.length; ++i) {
        if (k1[i] != k2[i]) return false;
        if (typeof j1[k1[i]] != typeof j2[k2[i]]) return false;
        if (j1[k1[i]] != j2[k2[i]]) return false;
    }
    return true;
}

function update_retina_image(img_object) {
    var is_retina = img_object.attr("src").match(/^(.*)@2x(\..*)$/);
    if (is_retina) {
        img_object.attr("src", is_retina[1] + is_retina[2]);
    }
    img_object.attr("width", "");
    img_object.attr("height", "");
    new RetinaImage(img_object[0])
}

function replace_image(img_object, nem_img_filename) {
    var base = img_object.attr("src").match(/([^\.]+\/)[^\/]+/)[1];
    img_object.attr("src", base + nem_img_filename)
    update_retina_image(img_object);
}

function leaky_update(url, min_refresh_rate, user_data, success_clb, fail_clb) {
    var old_json    = (arguments.length > 5) ? arguments[5] : null;
    var water_drops = (arguments.length > 6) ? arguments[6] : 0;

    $.getJSON(url)
        .done(function(json_data) {
            if (!old_json || !compare_json(old_json, json_data)) {
                water_drops = 0;
                success_clb(user_data, json_data);
            } else {
                ++water_drops;
            }

            var next_update = Math.min(1000 * Math.pow(2, water_drops),
                                       1000 * min_refresh_rate);
            setTimeout(function() {
                           leaky_update(url,
                                        min_refresh_rate,
                                        user_data,
                                        success_clb,
                                        fail_clb,
                                        json_data,
                                        water_drops);
                       }, next_update);
        })

        .fail(function(data) {
            fail_clb(user_data, data);
        });
}

function format_timestamp(iso_timestamp) {
    var date_obj = new Date(iso_timestamp)
    return date_obj.toLocaleDateString() + " " + date_obj.toLocaleTimeString();
}

function update_stratum0_display(s0_dom_id, json_data) {
    if (initial_stratum0_revision != json_data.revision) {
        location.reload();
    }

    $(s0_dom_id + " .stratum0_revision"     ).html(json_data.revision);
    $(s0_dom_id + " .stratum0_version"      ).html(json_data.version);
    $(s0_dom_id + " .stratum0_last_modified").html(format_timestamp(json_data.last_modified));
    $(s0_dom_id + " .stratum0_root_catalog" ).html(json_data.root_catalog_hash);
}

function update_stratum1_display(s1_dom_id, json_data) {
    if (initial_stratum0_revision != json_data.stratum0_revision) {
        location.reload();
    }

    var s1_status_img         = $(s1_dom_id + " .stratum1_state");
    var s1_details_div        = $(s1_dom_id + " .stratum1_details");
    var s1_replication_button = $(s1_dom_id + " .stratum1_repl_button");

    if (json_data.status != "ok") {
        // show a red flag if something went wrong
        var s1_status_img = $(s1_dom_id + " .stratum1_state");
        replace_image(s1_status_img, "fail.png");
        s1_details_div.hide();
        return;
    } else {
        // uncover details div
        $(s1_dom_id + " .stratum1_details").show();
    }

    // insert status icon
    if (json_data.replicating == "True") {
        replace_image(s1_status_img, "spinner.gif");
    } else if (json_data.revision != json_data.stratum0_revision) {
        replace_image(s1_status_img, "cross.png");
    } else {
        replace_image(s1_status_img, "tick.png");
    }

    // insert CernVM-FS version
    var v_str = "(does not provide RESTful API)";
    if (json_data.rest_api == "True") {
        var v_str = "(running CernVM-FS " + json_data.version + ")";
    }
    $(s1_dom_id + " .stratum1_version").html(v_str);

    // insert Stratum1 revision numbers
    $(s1_dom_id + " .stratum1_revision").html(json_data.revision);

    // insert last replication timestamp
    if (json_data.last_replication != "unknown") {
        $(s1_dom_id + " .stratum1_last_repl_info").show()
        $(s1_dom_id + " .stratum1_last_repl").html(format_timestamp(json_data.last_replication));
    } else {
        $(s1_dom_id + " .stratum1_last_repl_info").hide()
    }

    // show replication button
    if (json_data.rest_api == "True" &&
        json_data.revision != json_data.stratum0_revision)
    {
        s1_replication_button.show();
    } else {
        s1_replication_button.hide();
    }
    update_retina_image($(s1_dom_id + " .stratum1_repl_button img"));
}

function update_stratum0_status(stratum0_fqrn) {
    leaky_update(
        stratum0_info_url,
        5 * 60,
        '#stratum0',

        update_stratum0_display,
        function(user_data, data) {});
}

function update_stratum1_status(stratum1) {
    leaky_update(
        stratum1.info_url,
        5 * 60,
        '#stratum1_' + stratum1.id,

        update_stratum1_display,
        function(s1_dom_id, json_data) {
            var s1_status_img = $(s1_dom_id + " .stratum1_state");
            replace_image(s1_status_img, "fail.png")
        });
}

window.onload = function() {
    update_stratum0_status(stratum0_fqrn);
    for (var i = 0; i < stratum1s.length; ++i) {
        update_stratum1_status(stratum1s[i]);
    }
}
</script>

<h2>Local Stratum 0</h2>
<div class="container" id="stratum0">
    <table class="table">
        <tr>
            <td>Stratum0 Revision:</td>
            <td class="stratum0_revision"></td>
        </tr>
        <tr>
            <td>CernVM-FS Version:</td>
            <td class="stratum0_version"></td>
        </tr>
        <tr>
            <td>Last Modified:</td>
            <td class="stratum0_last_modified"></td>
        </tr>
        <tr>
            <td>Root Catalog Hash:</td>
            <td class="stratum0_root_catalog"></td>
        </tr>
        <tr>
            <td>Number of known Stratum 1 Replicas:</td>
            <td class="stratum0_replicas">{{ stratum1_list|length }}</td>
        </tr>
    </table>
</div>

<h2>Stratum 1 Replicas</h2>

{% for stratum1 in stratum1_list %}
<div class="container" style="margin-bottom: 20px" id="stratum1_{{ stratum1.id }}">
    <div class="pull-left" style="margin-right: 20px; width: 64px; height: 64px">
        <img src="{% static "images/loading.gif" %}" class="stratum1_state">
    </div>
    <div class="container pull-left" style="width: 500px">
        <div>
            <h4>{{ stratum1.name }} Replica <small class="stratum1_version"></small></h4>
        </div>
        <div class="stratum1_details" style="display: none;">
            Current Revision: <span class="stratum1_revision"></span>
            <small class="stratum1_last_repl_info" style="display: none;">(Last Replication: <span class="stratum1_last_repl"></span>)</small>
        </div>
    </div>
    <div class="pull-left stratum1_repl_button" style="margin-top: 16px; display: none;">
         <a href="{% url 'replicate' stratum0.fqrn stratum1.id %}" class="stratum1_repl_link">
             <img src="{% static "images/replicate.png" %}" width="32px" height="32px">
         </a>
    </div>
</div>
{% endfor %}

{% endblock %}
